---
phase: 07-story-lifecycle-executor
plan: 02
type: tdd
domain: go
---

<objective>
Create lifecycle executor package that runs the complete workflow sequence for a single story.

Purpose: Orchestrate the full story lifecycle (status→workflow→update status→next workflow→etc.) until the story is done.
Output: Working, tested Executor in internal/lifecycle package.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-lifecycle-definition/06-01-SUMMARY.md
@.planning/phases/07-story-lifecycle-executor/07-01-SUMMARY.md (after Plan 01 completes)

# Key files:

@internal/router/lifecycle.go
@internal/workflow/workflow.go
@internal/status/reader.go
@internal/status/writer.go (created in Plan 01)

**Tech stack available:** Go, testify
**Established patterns:** Interface-based design, dependency injection, table-driven tests
**Constraining decisions:**

- Phase 6: GetLifecycle returns []LifecycleStep with {Workflow, NextStatus}
- Phase 7-01: Writer.UpdateStatus updates sprint-status.yaml

**Dependencies:**

- Plan 07-01 must be complete (provides status.Writer)
  </context>

<feature>
  <name>Lifecycle Executor</name>
  <files>internal/lifecycle/executor.go, internal/lifecycle/executor_test.go</files>
  <behavior>
    Execute(ctx context.Context, storyKey string) error

    Cases:
    - Story in backlog → runs create-story, dev-story, code-review, git-commit → updates status after each → returns nil
    - Story in ready-for-dev → runs dev-story, code-review, git-commit → updates status after each → returns nil
    - Story in review → runs code-review, git-commit → updates status after each → returns nil
    - Story already done → returns router.ErrStoryComplete
    - Workflow fails mid-cycle → returns error, status left at last successful step
    - Status update fails → returns error (workflow succeeded but status not updated)

    The executor should:
    1. Get current story status via StatusReader
    2. Get lifecycle steps via router.GetLifecycle(status)
    3. For each step:
       a. Run workflow via Runner.RunSingle()
       b. If workflow fails, return error (fail-fast)
       c. Update status via StatusWriter.UpdateStatus()
       d. If status update fails, return error
    4. Return nil on success (all steps complete)

  </behavior>
  <implementation>
    Create Executor struct with dependency injection:

    type Executor struct {
        runner       *workflow.Runner
        statusReader *status.Reader
        statusWriter *status.Writer
    }

    func NewExecutor(runner *workflow.Runner, reader *status.Reader, writer *status.Writer) *Executor

    func (e *Executor) Execute(ctx context.Context, storyKey string) error

    For testing, Runner.RunSingle needs to be mockable. Options:
    - Create RunnerInterface that both Runner and MockRunner implement
    - Or test with integration approach using MockExecutor (Claude executor mock)

    Prefer the interface approach for cleaner unit tests:
    - Define WorkflowRunner interface in lifecycle package
    - workflow.Runner already satisfies it
    - Create MockWorkflowRunner for tests

  </implementation>
</feature>

<verification>
go test ./internal/lifecycle/... -v
go test ./... -v  # Ensure no regressions
</verification>

<success_criteria>

- Failing test written and committed (RED)
- Implementation passes test (GREEN)
- Refactor complete if needed
- All 2-3 commits present
- go test ./internal/lifecycle/... passes
- Phase 7 complete: ready for Phase 8 (Update Run Command)
  </success_criteria>

<output>
After completion, create `.planning/phases/07-story-lifecycle-executor/07-02-SUMMARY.md` with:
- RED: What test was written, why it failed
- GREEN: What implementation made it pass
- REFACTOR: What cleanup was done (if any)
- Commits: List of commits produced

Update .planning/STATE.md:

- Current position: Phase 7 complete
- Progress: Update percentage

Update .planning/ROADMAP.md:

- Mark Phase 7 complete with date
  </output>
